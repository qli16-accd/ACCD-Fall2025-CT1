<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>字符图像生成器 · Text Texture / ASCII Art</title>
  <style>
    :root{
      --bg:#f9fafc;
      --panel:#ffffff;
      --accent:#4a90e2;
      --mono: "Courier New", Consolas, Monaco, monospace;
      --text:#222;
      --muted:#666;
    }
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:Inter, Arial, sans-serif;
    }
    .wrap{
      max-width:1100px;
      margin:28px auto;
      padding:22px;
      background:var(--panel);
      border-radius:12px;
      box-shadow:0 6px 20px rgba(0,0,0,0.08);
    }
    h1{margin:0 0 8px; font-size:20px; color:var(--accent);}
    p {margin:6px 0 16px; color:var(--muted); font-size:14px;}
    .controls {display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px;}
    .card {
      background:var(--panel);
      padding:12px;
      border-radius:8px;
      min-width:220px;
      box-shadow:inset 0 1px 0 rgba(0,0,0,0.05);
    }
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px;}
    input[type="range"], select, input[type="file"], input[type="number"] {
      width:100%;
    }
    button {
      background:var(--accent);
      color:#fff;
      border:none;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
    }
    button:hover {opacity:0.9;}
    .output {margin-top:16px; display:flex; gap:12px; align-items:flex-start;}
    .preview {
      background:#39393a;
      padding:8px;
      border-radius:6px;
      overflow:auto;
      max-height:68vh;
      flex:1;
    }
    pre.ascii {
      font-family: var(--mono);
      line-height:0.95;
      font-size:8px;
      white-space:pre;
      margin:0;
      letter-spacing:0;
      color:#000;
    }
    .hint {font-size:12px; color:var(--muted); margin-top:8px;}
    .small {font-size:12px; color:var(--muted);}
    .row {display:flex; gap:8px;}
    input[type="checkbox"]{transform:scale(1.15); margin-right:6px;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>字符图像生成器 — Text Texture / ASCII Art</h1>
    <p>上传图片 → 调整字符集与宽度 → 生成由纯文本（HTML 字符）构成的图像。可选择彩色或单色输出。</p>

    <div class="controls">
      <div class="card">
        <label>上传图片 Upload picture</label>
        <input id="file" type="file" accept="image/*" />
        <div class="hint small">支持 JPG/PNG/GIF（静态第一帧）</div>
      </div>

      <div class="card">
        <label>输出字符列数（宽度） Width</label>
        <input id="columns" type="range" min="40" max="300" value="120" />
        <div class="row"><input id="columnsVal" type="number" value="120" min="10" max="1000" /></div>
      </div>

      <div class="card">
        <label>字符集（由亮到暗） Characters</label>
        <input id="charset" type="text" value="@%#*+=-:. " />
      </div>

      <div class="card">
        <label>字符字号（影响显示大小） Size</label>
        <input id="fontSize" type="range" min="6" max="18" value="8" />
        <div class="row"><span class="small">当前：<span id="fontSizeVal">8</span>px</span></div>
      </div>

      <div class="card">
        <label>输出选项Settings</label>
        <div><input id="colorOn" type="checkbox" checked /> 彩色输出（保留原色）Colored</div>
        <div style="margin-top:8px;"><input id="invert" type="checkbox" /> 反转亮度映射</div>
      </div>
    </div>

    <div style="display:flex; gap:8px; align-items:center;">
      <button id="generate">生成字符图 Generate</button>
      <button id="download">下载为 HTML Download as HTML</button>
      <button id="clear">清除 Clear</button>
      <div style="flex:1"></div>
      <div class="small">提示：用小字符字号 + 多列可得到更细腻的效果。</div>
    </div>

    <div class="output">
      <div class="preview card" style="flex:1;">
        <div style="margin-bottom:8px; color:var(--muted); font-size:13px;">预览（纯文本）Preview</div>
        <div id="resultWrap" style="white-space:pre-wrap;">
          <pre id="result" class="ascii" aria-live="polite"></pre>
        </div>
      </div>
      <div class="card" style="width:260px;">
        <div style="margin-bottom:10px; color:var(--muted); font-size:13px;">原图预览Preview of the original picture</div>
        <canvas id="canvas" style="width:100%; background:#f9fafc; display:block; border-radius:6px;"></canvas>
        <div class="hint small">用于像素采样（不会上传到任何服务器）。</div>
      </div>
    </div>
  </div>

  <script>
    // 获取 DOM
    const fileInput = document.getElementById('file');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const result = document.getElementById('result');
    const columnsRange = document.getElementById('columns');
    const columnsVal = document.getElementById('columnsVal');
    const charsetInput = document.getElementById('charset');
    const fontSizeRange = document.getElementById('fontSize');
    const fontSizeVal = document.getElementById('fontSizeVal');
    const colorOn = document.getElementById('colorOn');
    const invert = document.getElementById('invert');
    const generateBtn = document.getElementById('generate');
    const downloadBtn = document.getElementById('download');
    const clearBtn = document.getElementById('clear');

    let lastImage = null;

    // 同步滑条和输入框
    columnsRange.addEventListener('input', ()=> columnsVal.value = columnsRange.value);
    columnsVal.addEventListener('input', ()=> columnsRange.value = columnsVal.value);
    fontSizeRange.addEventListener('input', ()=> {
      fontSizeVal.textContent = fontSizeRange.value;
      result.style.fontSize = fontSizeRange.value + 'px';
    });

    // 载入图片
    fileInput.addEventListener('change', (ev) => {
      const file = ev.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = () => {
        URL.revokeObjectURL(url);
        lastImage = img;
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        ctx.drawImage(img, 0, 0);
      };
      img.src = url;
    });

    function brightnessFromPixel(r,g,b){
      return (0.2126*r + 0.7152*g + 0.0722*b) / 255;
    }

    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

    function generateASCII(){
      if (!lastImage) { alert('请先上传一张图片。Please uploade a picture first.'); return; }
      const columns = parseInt(columnsRange.value, 10);
      const charset = charsetInput.value || '@%#*+=-:. ';
      const fontSize = parseInt(fontSizeRange.value, 10);
      const useColor = colorOn.checked;
      const doInvert = invert.checked;

      const imgW = lastImage.naturalWidth;
      const imgH = lastImage.naturalHeight;
      const aspectCorrection = 0.55;
      const rows = Math.round((imgH / imgW) * columns * aspectCorrection);

      const off = document.createElement('canvas');
      off.width = columns;
      off.height = rows;
      const offCtx = off.getContext('2d');
      offCtx.drawImage(lastImage, 0, 0, off.width, off.height);
      const imgData = offCtx.getImageData(0,0,off.width, off.height).data;

      let outHtml = '';
      for (let y=0;y<off.height;y++){
        for (let x=0;x<off.width;x++){
          const idx = (y*off.width + x)*4;
          const r = imgData[idx], g = imgData[idx+1], b = imgData[idx+2], a = imgData[idx+3];
          let bright = brightnessFromPixel(r,g,b);
          if (doInvert) bright = 1 - bright;
          const charIndex = clamp(Math.round((1 - bright) * (charset.length - 1)), 0, charset.length-1);
          const ch = charset[charIndex] || ' ';
          if (useColor) {
            outHtml += `<span style="color:rgb(${r},${g},${b})">${escapeHtml(ch)}</span>`;
          } else {
            outHtml += escapeHtml(ch);
          }
        }
        outHtml += '\n';
      }

      result.style.fontSize = fontSize + 'px';
      result.style.lineHeight = (fontSize * 0.95) + 'px';
      result.innerHTML = outHtml;
    }

    function escapeHtml(s){
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    generateBtn.addEventListener('click', generateASCII);

    clearBtn.addEventListener('click', ()=>{
      result.textContent = '';
      ctx.clearRect(0,0,canvas.width,canvas.height);
      fileInput.value = '';
      lastImage = null;
    });

    downloadBtn.addEventListener('click', () => {
      if (!result.innerHTML) { alert('请先生成字符图后再下载。Please generate first then download.'); return; }
      const html = buildStandaloneHtml(result.innerHTML, parseInt(fontSizeRange.value,10));
      const blob = new Blob([html], {type: 'text/html;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ascii_art.html';
      a.click();
      URL.revokeObjectURL(url);
    });

    function buildStandaloneHtml(innerHtml, fontSize){
      return `<!doctype html>
<html><head><meta charset="utf-8"><title>ASCII Art</title>
<style>
body{background:#fff;color:#000;padding:20px;font-family:monospace;}
pre{white-space:pre; font-family:monospace; font-size:${fontSize}px; line-height:${Math.round(fontSize*0.95)}px;}
</style></head><body><pre>${innerHtml}</pre></body></html>`;
    }

    // 初始化字体
    result.style.fontSize = fontSizeRange.value + 'px';
    fontSizeVal.textContent = fontSizeRange.value;
  </script>
</body>
</html>
